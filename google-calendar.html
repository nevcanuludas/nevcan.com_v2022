<html>
<head>
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
</head>
<body>
  <h2>Upcoming Events</h2>
  <div id="calendar"></div>

  <script>
    const calendarIds = [
      '0072942805560063dd60f78f2c2c70cc87e2226becaea62955dc4b7dc55b0e5f@group.calendar.google.com',
      'nevcanuludas@gmail.com',
      'f20ea54d8a8cb746730d6ae9a92b1de2318c4785dd95c4770daf517c54550a25@group.calendar.google.com',
      'tr.turkish#holiday@group.v.calendar.google.com'
    ];
    const apiKey = 'AIzaSyDG2lZCJjnVjXDmGiwBRd_ciW9Yfniekkw';

    async function fetchEvents(calendarId) {
      const now = new Date();

      // 2 months ago
      const past = new Date(now);
      past.setMonth(past.getMonth() - 2);
      const timeMin = past.toISOString();

      // 6 months from now
      const future = new Date(now);
      future.setMonth(future.getMonth() + 12);
      const timeMax = future.toISOString();

      const encodedId = encodeURIComponent(calendarId);
      const url = `https://www.googleapis.com/calendar/v3/calendars/${encodedId}/events?key=${apiKey}&timeMin=${timeMin}&timeMax=${timeMax}&showDeleted=false&singleEvents=true&orderBy=startTime`;

      const res = await fetch(url);
      const data = await res.json();

      if (!data.items) return [];

      const events = [];

      data.items.forEach(event => {
        const visibility = event.visibility || 'default';
        const status = event.transparency || 'opaque'; // opaque = busy, transparent = free

        if (visibility === 'private' && status === 'transparent') return;

        const end = event.end ? (event.end.dateTime || event.end.date) : undefined;

        if (visibility === 'private') {
          // Private and busy event: show as "BUSY"
          events.push({
            title: 'BUSY',
            start: event.start.dateTime || event.start.date,
            end: end,
            allDay: !!event.start.date,
          });
        } else {
          const start = event.start.dateTime || event.start.date;
          events.push({
            title: event.summary,
            start: start,
            end: end,
            allDay: !!event.start.date,
          });
        }
      });

      return events;
    }

    async function fetchAllEvents() {
      let allEvents = [];
      for (const calendarId of calendarIds) {
        const events = await fetchEvents(calendarId);
        allEvents = allEvents.concat(events);
      }
      return allEvents;
    }

    document.addEventListener('DOMContentLoaded', async function() {
      const calendarEl = document.getElementById('calendar');
      const events = await fetchAllEvents();

      const minDate = new Date();
      minDate.setMonth(minDate.getMonth() - 2);

      const maxDate = new Date();
      maxDate.setMonth(maxDate.getMonth() + 12);

      const calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        firstDay: 1,
        headerToolbar: {
          left: 'prev,next today',
          center: 'title',
          right: ''
        },
        events: events,
        datesSet: function(info) {
          const prevBtn = calendarEl.querySelector('.fc-prev-button');
          const nextBtn = calendarEl.querySelector('.fc-next-button');

          // Disable Prev if visible start <= minDate
          if (info.view.activeStart <= minDate) {
            prevBtn.setAttribute('disabled', 'disabled');
          } else {
            prevBtn.removeAttribute('disabled');
          }

          // Disable Next if visible end >= maxDate
          // activeEnd is exclusive, so allow comparison accordingly
          if (info.view.activeEnd >= maxDate) {
            nextBtn.setAttribute('disabled', 'disabled');
          } else {
            nextBtn.removeAttribute('disabled');
          }
        }
      });

      calendar.render();
    });
  </script>
</body>
</html>
